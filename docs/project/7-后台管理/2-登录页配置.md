# 	登录页配置

## 布局配置

- flex子元素设置flex百分比后， margin:auto就会居中。

  ```js
  <div style="display: flex;" class="bg-purple">
      <div style="flex: 0 0 50%;" class="bg-primary col-5 m-auto" >1</div>
  </div>
  ```

## 登录ui设置

```html
<template>
    <div>
        <div class="container">
            <div class="row">
                <div class="col-12 col-sm-9 col-md-7 col-lg-5 m-auto pt-5 ">
                    <div class="card mt-5  border-light">
                        <div class="card-header bg-white">
                            <h3 class="text-center my-1 text-secondary">
                                cili商城后台登录
                            </h3>
                        </div>
                        <div class="card-body">
                            <el-form ref="form" :model="form">
                                <el-form-item>
                                    <el-input v-model="form.username" 
                                              size="medium"
                                              placeholder="请输入用户名">
                                    </el-input>
                                </el-form-item>
                                <el-form-item>
                                    <el-input v-model="form.password" 
                                              size="medium" type="password"
                                              placeholder="请输入密码">
                                    </el-input>
                                </el-form-item>
                                <el-form-item>
                                    <el-button type="primary" size="medium"
                                               class="w-100">
                                        立即登录
                                    </el-button>
                                </el-form-item>
                            </el-form>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>
</template>

<script>
    export default {
        data() {
            return {
                form:{
                    username:"",
                    password:""
                }
            }
        },
    }
</script>

<style>
</style>

```

## 登录表单验证

[element表单验证](https://element.eleme.cn/#/zh-CN/component/form)

```js
Form 组件提供了表单验证的功能，只需要通过 rules 属性传入约定的验证规则，并将 Form-Item 的 prop 属性设置为需校验的字段名即可。校验规则参见 async-validator
```

- el-form 绑定rules验证规则

- el-form-item 传入验证规则prop

- 点击登录也验证

  - ```js
    <el-form ref="ruleForm">
    ```

  - el-buttom添加提交事件

```html
<el-form ref="ruleForm" :model="form" :rules="rules">
	<el-form-item  prop="username">
        <el-input v-model="form.username" size="medium" placeholder="请输入用户名"></el-input>
    </el-form-item>
	<el-form-item  prop="password">
        <el-input v-model="form.password" size="medium" type="password" placeholder="请输入密码"></el-input>		</el-form-item>
	<el-form-item>
        <el-button
                   @click="submit"
                   type="primary" size="medium" class="w-100 p-3">立即登录</el-button>
    </el-form-item>
</el-form>

```

```js
export default {
    data() {
        return {
            form:{
                username:"",
                password:""
            },
            rules:{
                username:[  //失去焦点触发，必传，信息是请输入用户名
                    { required:true,message:"请输入用户名",trigger:'blur' }
                ],
                password:[
                    { required:true,message:"请输入密码",trigger:'blur' }
                ]
            }
        }
    },
    methods: {
        submit() {
            this.$refs.ruleForm.validate((e)=>{
                if (!e) return;
                // 提交表单
                this.$router.push({name:'index'})
            })
        }
    },
}
```

## 管理员相关api

### 登录

##### 接口功能

> 管理员登录

##### URL

> http://cilishop.cmsapi.cchenzw.top/admin/login

##### 支持格式

> JSON

##### HTTP请求方式

> POST

##### 请求参数

> | 参数     | 必选 | 类型   | 说明   |
> | :------- | :--- | :----- | ------ |
> | username | ture | String | 用户名 |
> | password | ture | String | 密码   |

## 管理员退出登录

##### 接口功能

> 管理员退出登录

##### URL

> http://ceshi5.dishait.cn/admin/logout

##### 支持格式

> JSON

##### HTTP请求方式

> POST

##### header头

> | 参数  | 必选 | 类型   | 说明  |
> | :---- | :--- | :----- | ----- |
> | token | ture | String | token |

##### 接口示例

> http://ceshi5.dishait.cn/admin/logout
>
> ```json
> 无
> ```

## 前后端交互

### 登录成功处理

- 表单提交后，如果出错，就弹出错误信息。
- 如果登录成功，把登录信息存储到本地和vuex
- 存储到本地存储，需要把对象进行字符串转换，但是token是字符串，不需要进行转换

```js
submit() {
    this.$refs.ruleForm.validate((e)=>{
        if (!e) return;
        // 提交表单
        this.axios.post('/admin/login',this.form).then(res=>{
            // 存储到vuex
            // 存储到本地存储
            this.$store.commit('login',res.data.data)
            // 成功提示
            this.$message('登录成功')
            // 跳转后台首页
            this.$router.push({name:'index'})
        }).catch(err=>{
           
        })
    })
}
```

```js
export default {
    state:{
        user:{},
        token:false
    },
    getters:{

    },
    mutations:{
        // 登录
        login(state,user){
            // 保存登录状态
            state.user = user
            state.token = user.token
            // 存储到本地存储
            window.sessionStorage.setItem('user',JSON.stringify(state.user))
            window.sessionStorage.setItem('token',state.token)
        }
    },
    actions:{

    }
}
```

### 登录状态保存

```js
// /store/modules/user.
mutations:{
    // 初始化用户信息
    initUser(state){
        let user = window.sessionStorage.getItem('user')
        if(user){
            state.user = JSON.parse(user)
            state.token = state.user.token
        }
    },

},
```

```js
//App.vue
created() {
    // 初始化用户信息
    this.$store.commit('initUser')
},
```

### 退出登录逻辑

- 退出登录需要携带token
- 退出后清空vuex和本地存储

```js
mutations: {

    // 退出
    logout(state, user) {
        state.user = false
        state.token = false
        window.sessionStorage.clear()

    }
},
```

```js
logout(){
    return this.axios.post('/admin/logout',{},{
        token:true，
        loading:true
    }).then(res=>{
        this.$message('退出成功');
        this.$store.commit('logout');
        // 返回登录页
        this.$router.push({name:'login'})
    }).catch(err=>{
        this.$store.commit('logout');
        // 返回到登录页
        this.$router.push({ name: 'login' });
    })
}
```

### bug处理-点击后防抖控制

- 如果多次点击会报promise错误。需要进行防抖

```html
<el-button type="primary" size="medium" class="w-100" @click="submit" :loading="loading">立即登录</el-button>
```

```js
data() {
    return {

        loading:false
    };
},
```

```js
submit() {
    this.$refs.ruleForm.validate((e)=>{
        if (!e) return;
        // 提交表单
        this.loading = true
        this.axios.post('/admin/login',this.form).then(res=>{

            this.loading = false

        }).catch(err=>{
            this.loading = false
        })
    })
}
```



