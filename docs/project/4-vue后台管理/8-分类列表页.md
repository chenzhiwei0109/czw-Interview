# 分类列表页

![image-20200912171945766](../../.vuepress/public/assets/img/image-20200912171945766.png)

## 页面和路由配置

```js
//	src/common/config/router.js
{
    meta:{title:'分类管理'},
    component:'shop/category/list'
}
```

https://element.eleme.cn/#/zh-CN/component/tree

```vue
// src/views/shop/category/list.vue
<template>
<div class="bg-white px-3" style="margin: -20px;margin-top: -1rem;margin-bottom: 0!important;">

    <el-tree :data="data" :props="defaultProps" @node-click="handleNodeClick"></el-tree>

    </div>
</template>

<script>
    export default {
        data(){
            return {
                data: [{
                    label: '一级 1',
                    children: [{
                        label: '二级 1-1',
                        children: [{
                            label: '三级 1-1-1'
                        }]
                    }]
                }, {
                    label: '一级 2',
                    children: [{
                        label: '二级 2-1',
                        children: [{
                            label: '三级 2-1-1'
                        }]
                    }, {
                        label: '二级 2-2',
                        children: [{
                            label: '三级 2-2-1'
                        }]
                    }]
                }, {
                    label: '一级 3',
                    children: [{
                        label: '二级 3-1',
                        children: [{
                            label: '三级 3-1-1'
                        }]
                    }, {
                        label: '二级 3-2',
                        children: [{
                            label: '三级 3-2-1'
                        }]
                    }]
                }],
                defaultProps: {
                    children: 'children',
                    label: 'label'
                }
            };
        },
        methods: {
            handleNodeClick(data) {
                console.log(data);
            }
        }
    }
</script>

<style>
</style>

```

## 自定义节点内容

![image-20200906144519444](../../.vuepress/public/assets/img/image-20200906144519444.png)

- default-expand-all默认展开所有
- 

```vue
<template>
	<div class="bg-white px-3" style="margin: -20px;margin-top: -1rem;margin-bottom: 0!important;">
		
		<el-tree :data="data" :props="defaultProps" @node-click="handleNodeClick"
		default-expand-all>
			
			<span class="custom-tree-node" slot-scope="{ node, data }">
				<span>{{ node.label }}</span>
				<span>
				  <el-button type="primary" size="mini">显示</el-button>
				  <el-button type="success" size="mini">增加</el-button>
				  <el-button type="warning" size="mini">修改</el-button>
				  <el-button type="danger" size="mini">删除</el-button>
				</span>
			  </span>
			
		</el-tree>
		
	</div>
</template>

<script>
	export default {
		data(){
			return {
				data: [{
				  label: '一级 1',
				  children: [{
					label: '二级 1-1',
					children: [{
					  label: '三级 1-1-1'
					}]
				  }]
				}, {
				  label: '一级 2',
				  children: [{
					label: '二级 2-1',
					children: [{
					  label: '三级 2-1-1'
					}]
				  }, {
					label: '二级 2-2',
					children: [{
					  label: '三级 2-2-1'
					}]
				  }]
				}, {
				  label: '一级 3',
				  children: [{
					label: '二级 3-1',
					children: [{
					  label: '三级 3-1-1'
					}]
				  }, {
					label: '二级 3-2',
					children: [{
					  label: '三级 3-2-1'
					}]
				  }]
				}],
				defaultProps: {
				  children: 'children',
				  label: 'label'
				}
			};
		},
		methods: {
		  handleNodeClick(data) {
			console.log(data);
		  }
		}
	}
</script>

<style>
.custom-tree-node {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 14px;
    padding-right: 8px;
}
.el-tree-node__content{
	padding: 20px 0;
}
</style>

```

## 交互-tree数据获取

- 因为label组件需要children和label作为每一个节点的两个属性，但是我们获取的对应代码格式并不是这样，所以需要进行对应的修改

- 需要把获取的tree数据里修改当状态属性editStatus为false。

  

  ![image-20200919190840299](../../.vuepress/public/assets/img/image-20200919190840299.png)

```html
<el-tree :data="data" :props="defaultProps" @node-click="handleNodeClick" default-expand-all :expand-on-click-node="false"
         draggable @node-drop="nodeDrop">
```

```js
defaultProps: {
    children: 'child',
    label: 'name'//element key默认为label,我们使用name代替
}
```

```js
__init() {
    this.layout.showLoading()
    this.axios.get('/admin/category',{
        token:true
    }).then(res=>{
        let data = res.data.data
        console.log(data);
        let addEditStatus = function(arr){
            arr.forEach(item=>{
                item.editStatus = false
                if(item.child.length){
                    addEditStatus(item.child)
                }
            })
        }
        addEditStatus(data)
        this.data = data
        this.layout.hideLoading()
    }).catch(err=>{
        this.layout.hideLoading()
    })
},
```

## 交互-显示隐藏分类切换

```html
<el-button :type="data.status ? 'primary' : 'danger'" 
           size="mini" @click.stop="showOrHide(data)">
    {{data.status ? '显示' : '隐藏'}}
</el-button>
```

```js
showOrHide(data){
    data.status = data.status ? 0 : 1
}
```

## 分类昵称修改

- 点击按钮后判断当前节点编辑状态并进行切换

```html
<el-tree :data="data" :props="defaultProps" @node-click="handleNodeClick"
         default-expand-all :expand-on-click-node="false">
    <span class="custom-tree-node" slot-scope="{ node, data }">
        <div>
            <el-input v-if="data.editStatus" v-model="data.label" size="mini"></el-input>
            <span v-else>{{ node.label }}</span>
        </div>
        <el-button :type="data.editStatus ? 'default':'warning'" size="mini" @click="edit(data)">{{data.editStatus ? '完成':'修改'}}</el-button>
    </span>
    </span>

</el-tree>
```

```js
每一项添加一个是否编辑的状态
editStatus:false
{
    label: '一级 1',
    status:1,
    editStatus:false,
    children: [{
        label: '二级 1-1',
        status:1,
        editStatus:false,
        children: [{
            label: '三级 1-1-1',
            status:1,
            editStatus:false,
        }]
    }]
}, 
```

```js
// 编辑|提交
edit(data){
    data.editStatus = !data.editStatus
}
```

## 分类删除

- 因为是多及分类删除，所以要删除父节点对应的children子节点

```html
<el-tree :data="data" :props="defaultProps" @node-click="handleNodeClick"
         default-expand-all :expand-on-click-node="false">
    <span class="custom-tree-node" slot-scope="{ node, data }">
        <el-button type="danger" size="mini" @click="remove(node,data)">删除</el-button>
    </span>
    </span>

</el-tree>
```

```js
remove(node, data) {
    this.$confirm("此操作将删除该分类, 是否继续?", "提示", {
        confirmButtonText: "删除",
        cancelButtonText: "取消",
        type: "warning",
    }).then(() => {
        this.layout.showLoading();
        this.axios
            .delete("/admin/category/" + data.id, {
            token: true,
        })
            .then((res) => {
            this.__init();
            this.$message({
                message: "删除成功",
                type: "success",
            });
            this.layout.hideLoading();
        })
            .catch((err) => {
            this.layout.hideLoading();
        });
    });
},
```

## 子分类增加

```html
<el-button type="success" size="mini"
           @click="appendChild(data)">增加</el-button>
```

```js
// 增加子分类
appendChild(data) {
    this.layout.showLoading();
    this.axios
        .post(
        "/admin/category",
        {
            status: 0,
            name: "新分类",
            category_id: data.id,
        },
        {
            token: true,
        }
    )
        .then((res) => {
        let obj = res.data.data;
        obj.editStatus = true;
        obj.child = [];
        data.child.push(obj);
        this.layout.hideLoading();
    })
        .catch((err) => {
        this.layout.hideLoading();
    });
},
```

## 顶级分类增加

```js
createTop() {
    this.$prompt("请输入顶级分类名称", "提示", {
        confirmButtonText: "创建",
        cancelButtonText: "取消",
        inputValidator: function (val) {
            if (val === "" || val === null) {
                return "顶级分类名称不能为空";
            }
            return true;
        },
    }).then(({ value }) => {
        this.layout.showLoading();
        this.axios
            .post(
            "/admin/category",
            {
                status: 0,
                category_id: 0,
                name: value,
            },
            {
                token: true,
            }
        )
            .then((res) => {
            this.__init();
            this.$message({
                message: "创建成功",
                type: "success",
            });
            this.layout.hideLoading();
        })
            .catch((err) => {
            this.layout.hideLoading();
        });
    });
},
```

## 拖拽排序

- 拖拽结束要比拖拽要先执行
- ![image-20200906164756516](../../.vuepress/public/assets/img/image-20200906164756516.png)

```JS
computed: {
    // 排序后的数据
    sortData() {
        let data = [];
        //扁平化
        let sort = function (arr) {
            arr.forEach((item) => {
                data.push(item);
                if (item.child.length) {
                    sort(item.child);
                }
            });
        };
        // 多维数组转一维数组
        sort(this.data);
        // 排序
        data = data.map((item, index) => {
            return {
                id: item.id,
                order: index,
                category_id: item.category_id,
            };
        });
        return data;
    },
},
```

```js
nodeDragEnd(...options) { //先执行
    // 被拖拽节点对应的数据
    let item = options[0].data;
    // 结束拖拽时最后进入的节点数据，这个数据不能为空
    let obj = options[1].data;
    if (obj) {
        //如果第三个参数是before或者after，他们的上级分类的id要相同
        if (options[2] === "before" || options[2] === "after") {
            item.category_id = obj.category_id;
        } else {
            item.category_id = obj.id;
        }
    }
},
```

```js
// 拖拽
nodeDrop(...options) {

    this.layout.showLoading();
    this.axios
        .post(
        "/admin/category/sort",
        {
            sortdata: JSON.stringify(this.sortData),
        },
        {
            token: true,
        }
    )
        .then((res) => {
        this.__init();
        this.layout.hideLoading();
    })
        .catch((err) => {
        this.layout.hideLoading();
    });
},
```



